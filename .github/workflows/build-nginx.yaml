name: Build Nginx Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Build Nginx
      run: |
        chmod +x build-nginx-deb.sh
        ./build-nginx-deb.sh
    
    - name: Find .deb file
      id: find_deb
      run: |
        DEB_FILE=$(find $HOME/nginx-build -name "nginx_*.deb" -type f | head -n 1)
        if [ -z "$DEB_FILE" ]; then
          echo "Error: No .deb file found!"
          exit 1
        fi
        cp "$DEB_FILE" ./
        DEB_FILENAME=$(basename "$DEB_FILE")
        echo "deb_file=$DEB_FILENAME" >> $GITHUB_OUTPUT
        echo "Found: $DEB_FILENAME"
        ls -lh "$DEB_FILENAME"
    
    - name: Calculate SHA256
      id: sha256
      run: |
        SHA256=$(sha256sum ${{ steps.find_deb.outputs.deb_file }} | awk '{print $1}')
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        echo "SHA256: $SHA256"
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: nginx_*.deb
        draft: false
        prerelease: false
        body: |
          ## ðŸš€ Nginx High Performance Build
          
          **Version:** ${{ github.ref_name }}
          **Package:** `${{ steps.find_deb.outputs.deb_file }}`
          **SHA256:** `${{ steps.sha256.outputs.sha256 }}`
          
          ### âœ¨ Features
          - âœ… Nginx 1.28.0 (stable)
          - âœ… OpenSSL 3.6.0 (latest)
          - âœ… HTTP/3 (QUIC) support
          - âœ… Brotli compression
          - âœ… VTS monitoring module
          - âœ… Headers More module (security headers control)
          - âœ… Cache Purge module (on-demand cache invalidation)
          - âœ… Hardened compilation flags (RELRO, Stack

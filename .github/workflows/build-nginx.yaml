name: Build Nginx Perf .deb

on:
  push:
    tags:
      - "v*"  # Trigger saat push tag, misal: v1.0.0

jobs:
  build-deb:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Penting: Izin untuk upload ke Release
    env:
      NGINX_VERSION: 1.28.0
      OPENSSL_VERSION: 3.6.0

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Make Build Script Executable
        run: chmod +x ./build-nginx.sh

      - name: Build Nginx .deb Package
        run: ./build-nginx-deb.sh

      - name: Locate .deb Artifact
        id: find_deb
        run: |
          # Cari file .deb yang baru dibuat
          FILE=$(find $HOME -maxdepth 5 -name "nginx-perf_*.deb" | head -n1)
          if [ -z "$FILE" ]; then
            echo "Error: No .deb file found!" >&2
            exit 1
          fi
          echo "Found package: $FILE"
          echo "file=${FILE}" >> "$GITHUB_OUTPUT"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ steps.find_deb.outputs.file }}
          draft: false
          prerelease: false
          # generate_release_notes: true  # Opsional: Auto-generate notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
